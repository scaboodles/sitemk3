var _e=Object.defineProperty;var ge=(t,e,n)=>e in t?_e(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var f=(t,e,n)=>ge(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();class y{constructor(e=0,n=0){f(this,"x");f(this,"y");this.x=e,this.y=n}magnitude(){return Math.sqrt(this.x**2+this.y**2)}setX(e){this.x=e}setY(e){this.y=e}set(e,n){this.x=e,this.y=n}setFromV2(e){this.x=e.x,this.y=e.y}add(e){this.x+=e.x,this.y+=e.y}static add(e,n){return new y(e.x+n.x,e.y+n.y)}sub(e){this.x-=e.x,this.y-=e.y}static sub(e,n){return new y(e.x+n.x,e.y+n.y)}distance(e){return Math.sqrt((this.x-e.x)**2+(this.y-e.y)**2)}scalarMult(e){this.x*=e,this.y*=e}lerp(e,n){n=Math.max(0,Math.min(1,n));const r=this.x+n*(e.x-this.x),i=this.y+n*(e.y-this.y);this.x=r,this.y=i}spread(){return[this.x,this.y]}damp(e){e=e>1?1:e,this.lerp(new y,1-e)}dampX(e){e=e>1?1:e,this.x=this.x*e}dampY(e){e=e>1?1:e,this.y=this.y*e}clampXAbs(e){this.x=Math.abs(this.x)>e?e:this.x}clampYAbs(e){this.y=Math.abs(this.y)>e?e:this.y}clampAbs(e){this.clampXAbs(e.x),this.clampXAbs(e.y)}expLerp(e,n,r=2){n=Math.max(0,Math.min(1,n));const i=1-Math.pow(1-n,r);this.x=this.x+(e.x-this.x)*i,this.y=this.y+(e.y-this.y)*i}normalize(){const e=this.magnitude();this.x=this.x/e,this.y=this.y/e}static lerp(e,n,r){return new y(...e.spread()).lerp(n,r)}}var X=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});function z(){var t=new X(16);return X!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function Ae(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function re(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],u=e[6],g=e[7],A=e[8],_=e[9],d=e[10],h=e[11],E=e[12],S=e[13],B=e[14],D=e[15],b=n[0],w=n[1],p=n[2],m=n[3];return t[0]=b*r+w*a+p*A+m*E,t[1]=b*i+w*l+p*_+m*S,t[2]=b*o+w*u+p*d+m*B,t[3]=b*s+w*g+p*h+m*D,b=n[4],w=n[5],p=n[6],m=n[7],t[4]=b*r+w*a+p*A+m*E,t[5]=b*i+w*l+p*_+m*S,t[6]=b*o+w*u+p*d+m*B,t[7]=b*s+w*g+p*h+m*D,b=n[8],w=n[9],p=n[10],m=n[11],t[8]=b*r+w*a+p*A+m*E,t[9]=b*i+w*l+p*_+m*S,t[10]=b*o+w*u+p*d+m*B,t[11]=b*s+w*g+p*h+m*D,b=n[12],w=n[13],p=n[14],m=n[15],t[12]=b*r+w*a+p*A+m*E,t[13]=b*i+w*l+p*_+m*S,t[14]=b*o+w*u+p*d+m*B,t[15]=b*s+w*g+p*h+m*D,t}function ie(t,e,n){var r=n[0],i=n[1],o=n[2],s,a,l,u,g,A,_,d,h,E,S,B;return e===t?(t[12]=e[0]*r+e[4]*i+e[8]*o+e[12],t[13]=e[1]*r+e[5]*i+e[9]*o+e[13],t[14]=e[2]*r+e[6]*i+e[10]*o+e[14],t[15]=e[3]*r+e[7]*i+e[11]*o+e[15]):(s=e[0],a=e[1],l=e[2],u=e[3],g=e[4],A=e[5],_=e[6],d=e[7],h=e[8],E=e[9],S=e[10],B=e[11],t[0]=s,t[1]=a,t[2]=l,t[3]=u,t[4]=g,t[5]=A,t[6]=_,t[7]=d,t[8]=h,t[9]=E,t[10]=S,t[11]=B,t[12]=s*r+g*i+h*o+e[12],t[13]=a*r+A*i+E*o+e[13],t[14]=l*r+_*i+S*o+e[14],t[15]=u*r+d*i+B*o+e[15]),t}function oe(t,e,n){var r=n[0],i=n[1],o=n[2];return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function he(t,e,n){var r=Math.sin(n),i=Math.cos(n),o=e[0],s=e[1],a=e[2],l=e[3],u=e[4],g=e[5],A=e[6],_=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*i+u*r,t[1]=s*i+g*r,t[2]=a*i+A*r,t[3]=l*i+_*r,t[4]=u*i-o*r,t[5]=g*i-s*r,t[6]=A*i-a*r,t[7]=_*i-l*r,t}function be(t,e,n,r,i,o,s){var a=1/(e-n),l=1/(r-i),u=1/(o-s);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*u,t[11]=0,t[12]=(e+n)*a,t[13]=(i+r)*l,t[14]=(s+o)*u,t[15]=1,t}var we=be;class pe{constructor(e){f(this,"viewMatrix");f(this,"projectionMatrix");f(this,"position");f(this,"zoom");f(this,"rotation");f(this,"left");f(this,"right");f(this,"top");f(this,"bottom");f(this,"near");f(this,"far");this.viewMatrix=z(),this.projectionMatrix=z(),this.position=new y(0,0),this.zoom=1,this.rotation=0;const n=e.context.canvas.width*.5,r=e.context.canvas.height*.5;this.left=-n,this.right=n,this.top=-r,this.bottom=r,this.near=-1,this.far=1,this.updateProjectionMatrix(),this.updateViewMatrix()}pan(e,n){this.position.x+=e,this.position.y+=n,this.updateViewMatrix()}setPosition(e,n){this.position.set(e,n),this.updateViewMatrix()}setZoom(e){this.zoom=e,this.zoom<.001&&(this.zoom=.001),this.updateViewMatrix()}setRotation(e){this.rotation=e,this.updateViewMatrix()}setOrthoBounds(e,n,r,i){this.left=e,this.right=n,this.top=r,this.bottom=i,this.updateProjectionMatrix()}updateProjectionMatrix(){we(this.projectionMatrix,this.left,this.right,this.bottom,this.top,this.near,this.far)}updateViewMatrix(){Ae(this.viewMatrix),this.zoom!==1&&oe(this.viewMatrix,this.viewMatrix,[this.zoom,this.zoom,1]),this.rotation!==0&&he(this.viewMatrix,this.viewMatrix,this.rotation),ie(this.viewMatrix,this.viewMatrix,[-this.position.x,-this.position.y,0])}}var Q=(t=>(t[t.LOCAL=0]="LOCAL",t[t.TERRAIN=1]="TERRAIN",t[t.REMOTE=2]="REMOTE",t))(Q||{});class q{constructor(e,n,r,i,o=!0){f(this,"position");f(this,"textureID");f(this,"texture");f(this,"scale");f(this,"id");f(this,"velocity");f(this,"mvpBuffer");f(this,"bindGroup");f(this,"static",!1);f(this,"collisions",!0);f(this,"grounded",!1);f(this,"metadata",{});f(this,"flipX",!1);if(!e.hasTexture(n))throw new Error(`Invalid texture id: ${n}, sprite ${r} not created`);const s=e.renderConf.device.createBuffer({size:4*4*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),a=e.textures.get(n),l=e.renderConf.device.createSampler({magFilter:"nearest",minFilter:"linear"});if(!a)throw new Error(`texture sampler for ${n}, sprite ${r} failed to instance`);this.texture=a;const u=e.renderConf.device.createBuffer({size:4*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),g=new Float32Array([0,1,1,0]);e.renderConf.device.queue.writeBuffer(u,0,g);const A=e.renderConf.device.createBindGroup({layout:e.renderConf.pipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:s}},{binding:1,resource:l},{binding:2,resource:a.createView()},{binding:3,resource:{buffer:u}}]});this.position=new y,this.textureID=n,this.scale=new y(1,1),this.id=r,this.velocity=new y,this.mvpBuffer=s,this.bindGroup=A,o&&(i==0?e.addLocalSprite(r,this):i==2?e.addRemoteSprite(r,this):(this.static=!0,e.addTerrain(this)))}getTexture(e){if(e.hasTexture(this.textureID))return e.getTexture(this.textureID);throw new Error(`attempt to access texture that doesnt exist for sprite ${this.id}`)}getBoundingBox(){return this.texture.width,this.texture.height,{left:this.position.x-this.scale.x/2,right:this.position.x+this.scale.x/2,top:this.position.y-this.scale.y/2,bottom:this.position.y+this.scale.y/2}}checkCollision(e){if(!this.collisions||!e.collisions)return 0;const n=this.getBoundingBox(),r=e.getBoundingBox(),i=n.top>r.top&&n.top<r.bottom,o=n.bottom>r.top&&n.bottom<r.bottom,s=n.right>r.left&&n.right<r.right,a=n.left<r.right&&n.left>r.left;let l=-1,u=-1,g=0,A=0;if(o||i){const _=n.right-r.left,d=r.right-n.left;a&&d<Math.abs(_)&&(A|=1,l=d),s&&_<Math.abs(d)&&(A|=2,l=_)}if(a||s){const _=n.bottom-r.top,d=r.bottom-n.top;i&&d<Math.abs(_)&&(console.log("top collide"),g|=4,u=d),o&&_<Math.abs(d)&&(g|=8,u=_)}return u<0&&l<0?0:u<0?A:A<0||u<l?g:A}checkCollisionBoundingBoxOnly(e){const n=this.getBoundingBox(),r=e,i=n.top>r.top&&n.top<r.bottom,o=n.bottom>r.top&&n.bottom<r.bottom,s=n.right>r.left&&n.right<r.right,a=n.left<r.right&&n.left>r.left;let l=-1,u=-1,g=0,A=0;if(o||i){const _=n.right-r.left,d=r.right-n.left;a&&d<Math.abs(_)&&(A|=1,l=d),s&&_<Math.abs(d)&&(A|=2,l=_)}if(a||s){const _=n.bottom-r.top,d=r.bottom-n.top;i&&d<Math.abs(_)&&(g|=4,u=d),o&&_<Math.abs(d)&&(g|=8,u=_)}return u<0&&l<0?0:u<0?A:A<0||u<l?g:A}checkAllCollisions(e){const n=[];return(Array.isArray(e)?e:Array.from(e)).filter(i=>i.collisions).forEach(i=>{let o=0;if(o|=this.checkCollision(i),!(o&0)){const s={type:o,collided:i};n.push(s)}}),n}checkWallCollisions(e){const n=[];return e.walls.forEach(r=>{let i=0;if(i|=this.checkCollisionBoundingBoxOnly(r),!(i&0)){const o={type:i,collided:r};i&8&&(this.grounded=!0),n.push(o)}}),n}lerpByVelocity(e){this.position.lerp(y.add(this.velocity,this.position),e.deltaTMS*.001)}lerpByVelocityConstantStep(e){this.position.lerp(y.add(this.velocity,this.position),e)}blockOnCollision(e,n,r=0){const i=e.getBoundingBox();if(n&1){if(this.velocity.x<0){const o=i.right+this.scale.x/2;this.position.setX(o),this.velocity.setX(this.velocity.x*r)}}else if(n&2&&this.velocity.x>0){const o=i.left-this.scale.x/2;this.position.setX(o),this.velocity.setX(this.velocity.x*r)}if(n&4){if(this.velocity.y<0){const o=i.bottom+this.scale.y/2;this.position.setY(o),this.velocity.setY(this.velocity.y*r)}}else if(n&8&&this.velocity.y>0){const o=i.top-this.scale.y/2;this.position.setY(o),this.velocity.setY(this.velocity.y*r),this.grounded=!0}}blockOnCollisionBoundingBoxOnly(e,n,r=0){const i=e;if(n&1){if(this.velocity.x<0){const o=i.right+this.scale.x/2;this.position.setX(o),this.velocity.setX(this.velocity.x*r)}}else if(n&2&&this.velocity.x>0){const o=i.left-this.scale.x/2;this.position.setX(o),this.velocity.setX(this.velocity.x*r)}if(n&4){if(this.velocity.y<0){const o=i.bottom+this.scale.y/2;this.position.setY(o),this.velocity.setY(this.velocity.y*r)}}else if(n&8&&this.velocity.y>0){const o=i.top-this.scale.y/2;this.position.setY(o),this.velocity.setY(this.velocity.y*r),this.grounded=!0}}blockOnAllCollisions(e,n=0){e.forEach(r=>{this.blockOnCollision(r.collided,r.type,n)})}resetGrounded(){this.grounded=!1}blockOnWalls(e,n=0){this.checkWallCollisions(e).forEach(r=>{this.blockOnCollisionBoundingBoxOnly(r.collided,r.type,n)})}blockOnTerrain(e,n=0){this.blockOnAllCollisions(this.checkAllCollisions(e.terrainSprites))}}class me{constructor(e,n,r,i,o){f(this,"wasm");f(this,"textures");f(this,"localSprites");f(this,"remoteSprites");f(this,"terrainSprites");f(this,"renderConf");f(this,"boundCamera");f(this,"lastT");f(this,"deltaTMS");f(this,"walls");f(this,"animationManagers");f(this,"metadata");this.wasm=r,this.textures=new Map,this.localSprites=new Map,this.remoteSprites=new Map,this.terrainSprites=[],this.renderConf=e,this.boundCamera=new pe(e),this.lastT=0,this.deltaTMS=0,this.walls=i,this.animationManagers=o,this.metadata={}}getTexture(e){const n=this.textures.get(e);if(n)return n;throw new Error("texture does not exist in scene")}getLocalSprite(e){const n=this.localSprites.get(e);if(n)return n;throw new Error("local sprite does not exist in scene")}getRemoteSprite(e){const n=this.remoteSprites.get(e);if(n)return n;throw new Error("remote sprite does not exist in scene")}hasLocalSprite(e){return this.localSprites.has(e)}hasRemoteSprite(e){return this.remoteSprites.has(e)}hasTexture(e){return this.textures.has(e)}localSpritesIterable(){return this.localSprites.values()}remoteSpriteIterable(){return this.remoteSprites.values()}addLocalSprite(e,n){this.hasLocalSprite(e)?console.error(`attempted duplicate id ${e} in local sprites, no changes`):this.localSprites.set(e,n)}addRemoteSprite(e,n){this.hasRemoteSprite(e)?console.error(`attempted duplicate id ${e} in remote sprites, no changes`):this.remoteSprites.set(e,n)}addTerrain(e){this.terrainSprites.push(e)}}class se extends q{constructor(n,r,i,o,s=!0){var A;const a=n.animationManagers.get(r);if(!a)throw new Error(`Animation manager with ID ${r} not found`);super(n,"debug",i,o,!1);f(this,"animationManager");f(this,"currAnimationState");f(this,"uvOffset",0);f(this,"uvOffsetBuffer");f(this,"currentFrame",0);f(this,"frameTimer",0);if(this.animationManager=a,this.currAnimationState=a.default,!a.atlasTexture)throw new Error(`Animation manager ${r} doesn't have an atlas texture yet`);this.uvOffsetBuffer=n.renderConf.device.createBuffer({size:4*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});for(const[_,d]of this.animationManager.stateMachine.entries())if(d===this.currAnimationState&&((A=this.animationManager.uvMap)!=null&&A.has(_))){const h=this.animationManager.uvMap.get(_);h&&h.length>0&&(this.uvOffset=h[0]);break}const l=Array.from(a.stateMachine.values()).reduce((_,d)=>_+d.imagePath.length,0),u=new Float32Array([this.uvOffset,a.frameWidth||0,a.frameHeight||0,l||1]);n.renderConf.device.queue.writeBuffer(this.uvOffsetBuffer,0,u);const g=n.renderConf.device.createSampler({magFilter:"nearest",minFilter:"linear"});this.bindGroup=n.renderConf.device.createBindGroup({layout:n.renderConf.pipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.mvpBuffer}},{binding:1,resource:g},{binding:2,resource:a.atlasTexture.createView()},{binding:3,resource:{buffer:this.uvOffsetBuffer}}]}),s&&(o==0?n.addLocalSprite(i,this):o==2?n.addRemoteSprite(i,this):(this.static=!0,n.addTerrain(this)))}updateUVOffset(n){if(this.animationManager.uvMap){let r;for(const[i,o]of this.animationManager.stateMachine.entries())if(o===this.currAnimationState){r=i;break}if(r&&this.animationManager.uvMap.has(r)){const i=this.animationManager.uvMap.get(r);if(i&&i.length>0){const o=Math.min(this.currentFrame,i.length-1);this.uvOffset=i[o];const s=Array.from(this.animationManager.stateMachine.values()).reduce((l,u)=>l+u.imagePath.length,0),a=new Float32Array([this.uvOffset,this.animationManager.frameWidth||0,this.animationManager.frameHeight||0,s||1]);n.renderConf.device.queue.writeBuffer(this.uvOffsetBuffer,0,a)}}}}setAnimationState(n){this.currAnimationState!==n&&(this.currAnimationState=n)}update(n){var i;const r=this.currAnimationState;if(this.animationManager.assignAnimationState(this),r!==this.currAnimationState)this.currentFrame=0,this.frameTimer=0,this.updateUVOffset(n);else{const o=this.currAnimationState.frameDuration||100;if(this.frameTimer+=n.deltaTMS,this.frameTimer>=o){const s=Array.from(this.animationManager.stateMachine.entries()).find(([a,l])=>l===this.currAnimationState);if(s){const a=s[0],l=(i=this.animationManager.uvMap)==null?void 0:i.get(a);l&&l.length>0&&(this.currentFrame=(this.currentFrame+1)%l.length,this.frameTimer=0,this.updateUVOffset(n))}}}}}function ye(t){const e=z();return re(e,t.projectionMatrix,t.viewMatrix),e}const Se=(t,e)=>{const n=t.createShaderModule({code:`
            struct Uniforms {
                mvp: mat4x4<f32>
            };

            struct AnimationUniforms {
                uvOffset: f32,
                frameWidth: f32,
                frameHeight: f32,
                frameCount: f32,
            }

            @group(0) @binding(0) var<uniform> uniforms: Uniforms;
            @group(0) @binding(1) var textureSampler: sampler;
            @group(0) @binding(2) var texture: texture_2d<f32>;
            @group(0) @binding(3) var<uniform> animUniforms: AnimationUniforms;

            struct VertexOutput {
                @builtin(position) position: vec4<f32>,
                @location(0) texCoords: vec2<f32>,
            };

            @vertex
            fn main_vertex(@location(0) position: vec2<f32>, @location(1) texCoords: vec2<f32>) -> VertexOutput {
                var output: VertexOutput;
                let worldPosition = vec4<f32>(position, 0.0, 1.0);
                output.position = uniforms.mvp * worldPosition;
                
                // Start with original texture coordinates
                output.texCoords = texCoords;
                return output;
            }

            @fragment
            fn main_fragment(@location(0) texCoords: vec2<f32>) -> @location(0) vec4<f32> {
                var finalTexCoords = texCoords;
                
                // For animated sprites, uvOffset contains the correct offset for the current frame
                // in the texture atlas. We need to scale the texCoords.x by the frame width
                // and add it to the offset
                if (animUniforms.frameCount > 1.0) {
                    let frameWidth = 1.0 / animUniforms.frameCount;
                    finalTexCoords.x = animUniforms.uvOffset + (texCoords.x * frameWidth);
                } else {
                    // For regular sprites, use the texCoords directly
                    finalTexCoords = texCoords;
                }
                
                let color = textureSample(texture, textureSampler, finalTexCoords);
                if (color.a < 0.01) {
                    discard;
                }
                return color;
            }
        `}),r={arrayStride:3*4+2*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x2"}]};return t.createRenderPipeline({layout:"auto",vertex:{module:n,entryPoint:"main_vertex",buffers:[r]},fragment:{module:n,entryPoint:"main_fragment",targets:[{format:e}]},primitive:{topology:"triangle-strip",frontFace:"ccw"}})},G=(t,e,n)=>{const r=e.renderConf,i=new Float32Array([.5,.5,0,0,1,.5,-.5,0,0,0,-.5,.5,0,1,1,-.5,-.5,0,1,0]),o=new Float32Array([.5,.5,0,1,1,.5,-.5,0,1,0,-.5,.5,0,0,1,-.5,-.5,0,0,0]),s=t.flipX?i:o,a=r.device.createBuffer({size:s.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,mappedAtCreation:!0});new Float32Array(a.getMappedRange()).set(s),a.unmap();const l=z();ie(l,l,[t.position.x,t.position.y,0]),oe(l,l,[t.scale.x,t.scale.y,1]);const u=ye(e.boundCamera);re(u,u,l),r.device.queue.writeBuffer(t.mvpBuffer,0,u),"update"in t&&typeof t.update=="function"&&t.update(e),n.setPipeline(r.pipeline),n.setBindGroup(0,t.bindGroup),n.setVertexBuffer(0,a),n.draw(4,1,0,0)},xe=t=>{const n={colorAttachments:[{view:t.renderConf.context.getCurrentTexture().createView(),clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]},r=t.renderConf.device.createCommandEncoder(),i=r.beginRenderPass(n);t.terrainSprites.forEach(o=>{G(o,t,i)}),t.remoteSprites.forEach((o,s)=>{G(o,t,i)}),t.localSprites.forEach((o,s)=>{G(o,t,i)}),i.end(),t.renderConf.device.queue.submit([r.finish()])},Ee=async(t=0,e=0,n="webGPU")=>{if(!navigator.gpu)return console.error("web gpu not supported"),null;const r=await navigator.gpu.requestAdapter();if(!r)return console.error("adapter failure"),null;const i=await r.requestDevice(),o=document.getElementById(n);let s=0,a=0;t==0&&(s=o.clientWidth*devicePixelRatio,o.width=s),e==0&&(a=o.clientHeight*devicePixelRatio,o.height=a);const l=o.getContext("webgpu"),u=navigator.gpu.getPreferredCanvasFormat();l.configure({device:i,format:u,alphaMode:"opaque"});const g=Se(i,u);return{device:i,format:u,context:l,pipeline:g,width:s,height:a}};async function ve(t,e){const n=new Image;n.src=e,await n.decode();const r=t.device.createTexture({size:[n.width,n.height,1],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});return t.device.queue.copyExternalImageToTexture({source:n},{texture:r},[n.width,n.height]),r}const P={UP:"ArrowUp",DOWN:"ArrowDown",LEFT:"ArrowLeft",RIGHT:"ArrowRight",SPACE:" ",SHIFT:"Shift",CTRL:"Control",ALT:"Alt",ESC:"Escape",ENTER:"Enter",TAB:"Tab",NUM_0:"0",NUM_1:"1",NUM_2:"2",NUM_3:"3",NUM_4:"4",NUM_5:"5",NUM_6:"6",NUM_7:"7",NUM_8:"8",NUM_9:"9",F1:"F1",F2:"F2",F3:"F3",F4:"F4",F5:"F5",F6:"F6",F7:"F7",F8:"F8",F9:"F9",F10:"F10",F11:"F11",F12:"F12",BACKSPACE:"Backspace",DELETE:"Delete",HOME:"Home",END:"End",PAGE_UP:"PageUp",PAGE_DOWN:"PageDown",A_KEY:"a",B_KEY:"b",C_KEY:"c",D_KEY:"d",E_KEY:"e",F_KEY:"f",G_KEY:"g",H_KEY:"h",I_KEY:"i",J_KEY:"j",K_KEY:"k",L_KEY:"l",M_KEY:"m",N_KEY:"n",O_KEY:"o",P_KEY:"p",Q_KEY:"q",R_KEY:"r",S_KEY:"s",T_KEY:"t",U_KEY:"u",V_KEY:"v",W_KEY:"w",X_KEY:"x",Y_KEY:"y",Z_KEY:"z",TILDE:"`",MINUS:"-",EQUALS:"=",OPEN_BRACKET:"[",CLOSE_BRACKET:"]",BACKSLASH:"\\",SEMICOLON:";",QUOTE:"'",COMMA:",",PERIOD:".",SLASH:"/"};function j(t){return!!Object.values(P).includes(t)}class Ce{constructor(){f(this,"keysDown",{});f(this,"keyDownOnce",{});this.initListeners()}initListeners(){Object.values(P).forEach(e=>{this.keyDownOnce[e]=[!1,!0]}),window.addEventListener("keydown",e=>{const n=e.key;j(n)&&(this.keysDown[n]=!0,this.keyDownOnce[n][1]&&(this.keyDownOnce[n][0]=!0,this.keyDownOnce[n][1]=!1))}),window.addEventListener("keyup",e=>{const n=e.key;j(n)&&(this.keysDown[n]=!1,this.keyDownOnce[n][0]=!1,this.keyDownOnce[n][1]=!0)})}isKeyDown(e){return this.keysDown[e]}onKeyDown(e){const n=this.keyDownOnce[e][0];return this.keyDownOnce[e][0]=!1,n}}class ke{constructor(){f(this,"audioContext");f(this,"clips",{});this.audioContext=new AudioContext}async preloadAudio(e,n){const i=await(await fetch(n)).arrayBuffer(),o=await this.audioContext.decodeAudioData(i);this.clips[e]=o}playSound(e,n=!1){const r=this.clips[e];if(!r){console.warn(`Audio clip '${e}' not found or not preloaded.`);return}const i=this.audioContext.createBufferSource();i.buffer=r,i.loop=n,i.connect(this.audioContext.destination),i.start(0)}}let c;function O(t){const e=c.__externref_table_alloc();return c.__wbindgen_export_2.set(e,t),e}function k(t,e){try{return t.apply(this,e)}catch(n){const r=O(n);c.__wbindgen_exn_store(r)}}function T(t){return t==null}const ae=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&ae.decode();let R=null;function K(){return(R===null||R.byteLength===0)&&(R=new Uint8Array(c.memory.buffer)),R}function I(t,e){return t=t>>>0,ae.decode(K().subarray(t,t+e))}let x=0;const L=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},Me=typeof L.encodeInto=="function"?function(t,e){return L.encodeInto(t,e)}:function(t,e){const n=L.encode(t);return e.set(n),{read:t.length,written:n.length}};function v(t,e,n){if(n===void 0){const a=L.encode(t),l=e(a.length,1)>>>0;return K().subarray(l,l+a.length).set(a),x=a.length,l}let r=t.length,i=e(r,1)>>>0;const o=K();let s=0;for(;s<r;s++){const a=t.charCodeAt(s);if(a>127)break;o[i+s]=a}if(s!==r){s!==0&&(t=t.slice(s)),i=n(i,r,r=s+t.length*3,1)>>>0;const a=K().subarray(i+s,i+r),l=Me(t,a);s+=l.written,i=n(i,r,s,1)>>>0}return x=s,i}let F=null;function C(){return(F===null||F.buffer.detached===!0||F.buffer.detached===void 0&&F.buffer!==c.memory.buffer)&&(F=new DataView(c.memory.buffer)),F}function H(t,e){return t=t>>>0,K().subarray(t/1,t/1+e)}const $=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>{c.__wbindgen_export_6.get(t.dtor)(t.a,t.b)});function U(t,e,n,r){const i={a:t,b:e,cnt:1,dtor:n},o=(...s)=>{i.cnt++;const a=i.a;i.a=0;try{return r(a,i.b,...s)}finally{--i.cnt===0?(c.__wbindgen_export_6.get(i.dtor)(a,i.b),$.unregister(i)):i.a=a}};return o.original=i,$.register(o,i,i),o}function Z(t){const e=typeof t;if(e=="number"||e=="boolean"||t==null)return`${t}`;if(e=="string")return`"${t}"`;if(e=="symbol"){const i=t.description;return i==null?"Symbol":`Symbol(${i})`}if(e=="function"){const i=t.name;return typeof i=="string"&&i.length>0?`Function(${i})`:"Function"}if(Array.isArray(t)){const i=t.length;let o="[";i>0&&(o+=Z(t[0]));for(let s=1;s<i;s++)o+=", "+Z(t[s]);return o+="]",o}const n=/\[object ([^\]]+)\]/.exec(toString.call(t));let r;if(n&&n.length>1)r=n[1];else return toString.call(t);if(r=="Object")try{return"Object("+JSON.stringify(t)+")"}catch{return"Object"}return t instanceof Error?`${t.name}: ${t.message}
${t.stack}`:r}function Ie(t,e){t=t>>>0;const n=C(),r=[];for(let i=t;i<t+4*e;i+=4)r.push(c.__wbindgen_export_2.get(n.getUint32(i,!0)));return c.__externref_drop_slice(t,e),r}function Be(t){const e=c.__wbindgen_export_2.get(t);return c.__externref_table_dealloc(t),e}function W(t,e,n){c.closure219_externref_shim(t,e,n)}function Te(t,e,n){c.closure246_externref_shim(t,e,n)}function Oe(t,e,n){c.closure259_externref_shim(t,e,n)}function Fe(t,e){c._dyn_core__ops__function__FnMut_____Output___R_as_wasm_bindgen__closure__WasmClosure___describe__invoke__h6fa27522f81883d4(t,e)}const Ue=["blob","arraybuffer"],Re=["arraybuffer","blob"],Qe=["new","checking","connected","completed","failed","disconnected","closed"],Pe=["new","gathering","complete"],Ke=["offer","pranswer","answer","rollback"],ee=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>c.__wbg_client_free(t>>>0,1));class Je{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,ee.unregister(this),e}free(){const e=this.__destroy_into_raw();c.__wbg_client_free(e,0)}constructor(){const e=c.client_new();return this.__wbg_ptr=e>>>0,ee.register(this,this.__wbg_ptr,this),this}set_url(e){const n=v(e,c.__wbindgen_malloc,c.__wbindgen_realloc),r=x;c.client_set_url(this.__wbg_ptr,n,r)}set_info(e){const n=v(e,c.__wbindgen_malloc,c.__wbindgen_realloc),r=x;c.client_set_info(this.__wbg_ptr,n,r)}get info(){let e,n;try{const r=c.client_info(this.__wbg_ptr);return e=r[0],n=r[1],I(r[0],r[1])}finally{c.__wbindgen_free(e,n,1)}}add_peer_info(e,n){const r=v(e,c.__wbindgen_malloc,c.__wbindgen_realloc),i=x,o=v(n,c.__wbindgen_malloc,c.__wbindgen_realloc),s=x;c.client_add_peer_info(this.__wbg_ptr,r,i,o,s)}getAllInfo(){return c.client_getAllInfo(this.__wbg_ptr)}add_super_peer(e,n){const r=v(e,c.__wbindgen_malloc,c.__wbindgen_realloc),i=x,o=v(n,c.__wbindgen_malloc,c.__wbindgen_realloc),s=x;c.client_add_super_peer(this.__wbg_ptr,r,i,o,s)}add_child_peer(e,n){const r=v(e,c.__wbindgen_malloc,c.__wbindgen_realloc),i=x,o=v(n,c.__wbindgen_malloc,c.__wbindgen_realloc),s=x;c.client_add_child_peer(this.__wbg_ptr,r,i,o,s)}remove_peer(e){const n=v(e,c.__wbindgen_malloc,c.__wbindgen_realloc),r=x;c.client_remove_peer(this.__wbg_ptr,n,r)}get_peers_to_retry(){const e=c.client_get_peers_to_retry(this.__wbg_ptr);var n=Ie(e[0],e[1]).slice();return c.__wbindgen_free(e[0],e[1]*4,4),n}start(){const e=c.client_start(this.__wbg_ptr);if(e[1])throw Be(e[0])}}async function Ye(t,e){if(typeof Response=="function"&&t instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,e)}catch(r){if(t.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await t.arrayBuffer();return await WebAssembly.instantiate(n,e)}else{const n=await WebAssembly.instantiate(t,e);return n instanceof WebAssembly.Instance?{instance:n,module:t}:n}}function De(){const t={};return t.wbg={},t.wbg.__wbg_addIceCandidate_e301d64de5bab94d=function(e,n){return e.addIceCandidate(n)},t.wbg.__wbg_buffer_61b7ce01341d7f88=function(e){return e.buffer},t.wbg.__wbg_call_b0d8e36992d9900d=function(){return k(function(e,n){return e.call(n)},arguments)},t.wbg.__wbg_candidate_3fa3d192f9eecd2e=function(e){const n=e.candidate;return T(n)?0:O(n)},t.wbg.__wbg_clearTimeout_96804de0ab838f26=function(e){return clearTimeout(e)},t.wbg.__wbg_close_4063e1bcbd6d5fe2=function(){return k(function(e){e.close()},arguments)},t.wbg.__wbg_code_71136b86e2aa7f41=function(e){return e.code},t.wbg.__wbg_code_cd82312abb9d9ff9=function(e){return e.code},t.wbg.__wbg_createAnswer_9f830cf62287290e=function(e){return e.createAnswer()},t.wbg.__wbg_createDataChannel_b0e7ba0ee7551b66=function(e,n,r,i){return e.createDataChannel(I(n,r),i)},t.wbg.__wbg_createOffer_77d10ea157cc1bae=function(e){return e.createOffer()},t.wbg.__wbg_data_4ce8a82394d8b110=function(e){return e.data},t.wbg.__wbg_debug_156ca727dbc3150f=function(e){console.debug(e)},t.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,n){let r,i;try{r=e,i=n,console.error(I(e,n))}finally{c.__wbindgen_free(r,i,1)}},t.wbg.__wbg_error_fab41a42d22bf2bc=function(e){console.error(e)},t.wbg.__wbg_get_bbccf8970793c087=function(){return k(function(e,n){return Reflect.get(e,n)},arguments)},t.wbg.__wbg_iceConnectionState_96d0e819375d3695=function(e){const n=e.iceConnectionState;return(Qe.indexOf(n)+1||8)-1},t.wbg.__wbg_iceGatheringState_272d259248e39488=function(e){const n=e.iceGatheringState;return(Pe.indexOf(n)+1||4)-1},t.wbg.__wbg_info_c3044c86ae29faab=function(e){console.info(e)},t.wbg.__wbg_instanceof_ArrayBuffer_670ddde44cdb2602=function(e){let n;try{n=e instanceof ArrayBuffer}catch{n=!1}return n},t.wbg.__wbg_instanceof_Blob_2fb69097f32d6784=function(e){let n;try{n=e instanceof Blob}catch{n=!1}return n},t.wbg.__wbg_length_65d1cd11729ced11=function(e){return e.length},t.wbg.__wbg_localDescription_ac6bdbde1834d62e=function(e){const n=e.localDescription;return T(n)?0:O(n)},t.wbg.__wbg_log_464d1b2190ca1e04=function(e){console.log(e)},t.wbg.__wbg_new_254fa9eac11932ae=function(){return new Array},t.wbg.__wbg_new_3ff5b33b1ce712df=function(e){return new Uint8Array(e)},t.wbg.__wbg_new_688846f374351c92=function(){return new Object},t.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},t.wbg.__wbg_new_9b6c38191d7b9512=function(){return k(function(e,n){return new WebSocket(I(e,n))},arguments)},t.wbg.__wbg_new_bc96c6a1c0786643=function(){return new Map},t.wbg.__wbg_newnoargs_fd9e4bf8be2bc16d=function(e,n){return new Function(I(e,n))},t.wbg.__wbg_newwithconfiguration_496479cef0f6908f=function(){return k(function(e){return new RTCPeerConnection(e)},arguments)},t.wbg.__wbg_newwithstrsequence_5b5601fc2c0bff30=function(){return k(function(e,n,r){return new WebSocket(I(e,n),r)},arguments)},t.wbg.__wbg_now_64d0bb151e5d3889=function(){return Date.now()},t.wbg.__wbg_parse_161c68378e086ae1=function(){return k(function(e,n){return JSON.parse(I(e,n))},arguments)},t.wbg.__wbg_push_6edad0df4b546b2c=function(e,n){return e.push(n)},t.wbg.__wbg_queueMicrotask_2181040e064c0dc8=function(e){queueMicrotask(e)},t.wbg.__wbg_queueMicrotask_ef9ac43769cbcc4f=function(e){return e.queueMicrotask},t.wbg.__wbg_readyState_236b61903e1dbb47=function(e){return e.readyState},t.wbg.__wbg_reason_17a506fc63aa299a=function(e,n){const r=n.reason,i=v(r,c.__wbindgen_malloc,c.__wbindgen_realloc),o=x;C().setInt32(e+4*1,o,!0),C().setInt32(e+4*0,i,!0)},t.wbg.__wbg_resolve_0bf7c44d641804f9=function(e){return Promise.resolve(e)},t.wbg.__wbg_sdp_b6dd8078e5da25d1=function(e,n){const r=n.sdp,i=v(r,c.__wbindgen_malloc,c.__wbindgen_realloc),o=x;C().setInt32(e+4*1,o,!0),C().setInt32(e+4*0,i,!0)},t.wbg.__wbg_send_8d1796bdf62d7537=function(){return k(function(e,n,r){e.send(I(n,r))},arguments)},t.wbg.__wbg_send_c2b76ede40fcced1=function(){return k(function(e,n,r){e.send(H(n,r))},arguments)},t.wbg.__wbg_send_c30f435bb2d77003=function(){return k(function(e,n,r){e.send(H(n,r))},arguments)},t.wbg.__wbg_setLocalDescription_b788ec2fd0674a96=function(e,n){return e.setLocalDescription(n)},t.wbg.__wbg_setRemoteDescription_d669d99de7807ea2=function(e,n){return e.setRemoteDescription(n)},t.wbg.__wbg_setTimeout_eefe7f4c234b0c6b=function(){return k(function(e,n){return setTimeout(e,n)},arguments)},t.wbg.__wbg_set_1d80752d0d5f0b21=function(e,n,r){e[n>>>0]=r},t.wbg.__wbg_set_23d69db4e5c66a6e=function(e,n,r){e.set(n,r>>>0)},t.wbg.__wbg_set_3f1d0b984ed272ed=function(e,n,r){e[n]=r},t.wbg.__wbg_set_76818dc3c59a63d5=function(e,n,r){return e.set(n,r)},t.wbg.__wbg_setbinaryType_2704a1179f1dae81=function(e,n){e.binaryType=Re[n]},t.wbg.__wbg_setbinaryType_3fa4a9e8d2cc506f=function(e,n){e.binaryType=Ue[n]},t.wbg.__wbg_seticeservers_b00d802d70f18bf7=function(e,n){e.iceServers=n},t.wbg.__wbg_setid_1e31ae38dd199f1e=function(e,n){e.id=n},t.wbg.__wbg_setmaxretransmits_6f61e654473f025b=function(e,n){e.maxRetransmits=n},t.wbg.__wbg_setnegotiated_adeee8a35c80b239=function(e,n){e.negotiated=n!==0},t.wbg.__wbg_setonclose_629a987007f094d6=function(e,n){e.onclose=n},t.wbg.__wbg_setonclose_f9c609d8c9938fa5=function(e,n){e.onclose=n},t.wbg.__wbg_setonerror_63a911ab4d90e28b=function(e,n){e.onerror=n},t.wbg.__wbg_setonerror_8ae2b387470ec52e=function(e,n){e.onerror=n},t.wbg.__wbg_setonicecandidate_6efe8084e067fa0b=function(e,n){e.onicecandidate=n},t.wbg.__wbg_setoniceconnectionstatechange_ccbe455983413d66=function(e,n){e.oniceconnectionstatechange=n},t.wbg.__wbg_setonicegatheringstatechange_6fb61f0de024221d=function(e,n){e.onicegatheringstatechange=n},t.wbg.__wbg_setonmessage_5e7ade2af360de9d=function(e,n){e.onmessage=n},t.wbg.__wbg_setonmessage_b53b0e68a6823042=function(e,n){e.onmessage=n},t.wbg.__wbg_setonopen_54faa9e83483da1d=function(e,n){e.onopen=n},t.wbg.__wbg_setonopen_be193e2f796876a6=function(e,n){e.onopen=n},t.wbg.__wbg_setordered_b25b9bae3e757f40=function(e,n){e.ordered=n!==0},t.wbg.__wbg_setsdp_d4eab241040f765d=function(e,n,r){e.sdp=I(n,r)},t.wbg.__wbg_settype_935b601281898749=function(e,n){e.type=Ke[n]},t.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,n){const r=n.stack,i=v(r,c.__wbindgen_malloc,c.__wbindgen_realloc),o=x;C().setInt32(e+4*1,o,!0),C().setInt32(e+4*0,i,!0)},t.wbg.__wbg_static_accessor_GLOBAL_0be7472e492ad3e3=function(){const e=typeof global>"u"?null:global;return T(e)?0:O(e)},t.wbg.__wbg_static_accessor_GLOBAL_THIS_1a6eb482d12c9bfb=function(){const e=typeof globalThis>"u"?null:globalThis;return T(e)?0:O(e)},t.wbg.__wbg_static_accessor_SELF_1dc398a895c82351=function(){const e=typeof self>"u"?null:self;return T(e)?0:O(e)},t.wbg.__wbg_static_accessor_WINDOW_ae1c80c7eea8d64a=function(){const e=typeof window>"u"?null:window;return T(e)?0:O(e)},t.wbg.__wbg_stringify_f4f701bc34ceda61=function(){return k(function(e){return JSON.stringify(e)},arguments)},t.wbg.__wbg_then_0438fad860fe38e1=function(e,n){return e.then(n)},t.wbg.__wbg_then_0ffafeddf0e182a4=function(e,n,r){return e.then(n,r)},t.wbg.__wbg_toJSON_ffaaeab21d6c96ee=function(e){return e.toJSON()},t.wbg.__wbg_url_e296f4f5d83d962b=function(e,n){const r=n.url,i=v(r,c.__wbindgen_malloc,c.__wbindgen_realloc),o=x;C().setInt32(e+4*1,o,!0),C().setInt32(e+4*0,i,!0)},t.wbg.__wbg_warn_123db6aa8948382e=function(e){console.warn(e)},t.wbg.__wbg_wasClean_303f938d5142dcca=function(e){return e.wasClean},t.wbg.__wbindgen_cb_drop=function(e){const n=e.original;return n.cnt--==1?(n.a=0,!0):!1},t.wbg.__wbindgen_closure_wrapper1044=function(e,n,r){return U(e,n,280,Fe)},t.wbg.__wbindgen_closure_wrapper635=function(e,n,r){return U(e,n,220,W)},t.wbg.__wbindgen_closure_wrapper637=function(e,n,r){return U(e,n,220,W)},t.wbg.__wbindgen_closure_wrapper639=function(e,n,r){return U(e,n,220,W)},t.wbg.__wbindgen_closure_wrapper708=function(e,n,r){return U(e,n,247,Te)},t.wbg.__wbindgen_closure_wrapper990=function(e,n,r){return U(e,n,260,Oe)},t.wbg.__wbindgen_debug_string=function(e,n){const r=Z(n),i=v(r,c.__wbindgen_malloc,c.__wbindgen_realloc),o=x;C().setInt32(e+4*1,o,!0),C().setInt32(e+4*0,i,!0)},t.wbg.__wbindgen_init_externref_table=function(){const e=c.__wbindgen_export_2,n=e.grow(4);e.set(0,void 0),e.set(n+0,void 0),e.set(n+1,null),e.set(n+2,!0),e.set(n+3,!1)},t.wbg.__wbindgen_is_function=function(e){return typeof e=="function"},t.wbg.__wbindgen_is_null=function(e){return e===null},t.wbg.__wbindgen_is_string=function(e){return typeof e=="string"},t.wbg.__wbindgen_is_undefined=function(e){return e===void 0},t.wbg.__wbindgen_memory=function(){return c.memory},t.wbg.__wbindgen_string_get=function(e,n){const r=n,i=typeof r=="string"?r:void 0;var o=T(i)?0:v(i,c.__wbindgen_malloc,c.__wbindgen_realloc),s=x;C().setInt32(e+4*1,s,!0),C().setInt32(e+4*0,o,!0)},t.wbg.__wbindgen_string_new=function(e,n){return I(e,n)},t.wbg.__wbindgen_throw=function(e,n){throw new Error(I(e,n))},t}function Ne(t,e){return c=t.exports,ce.__wbindgen_wasm_module=e,F=null,R=null,c.__wbindgen_start(),c}async function ce(t){if(c!==void 0)return c;typeof t<"u"&&(Object.getPrototypeOf(t)===Object.prototype?{module_or_path:t}=t:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof t>"u"&&(t=new URL("/mingle/assets/matchbox_super_client_bg-CmyeSnsp.wasm",import.meta.url));const e=De();(typeof t=="string"||typeof Request=="function"&&t instanceof Request||typeof URL=="function"&&t instanceof URL)&&(t=fetch(t));const{instance:n,module:r}=await Ye(await t,e);return Ne(n,r)}let N=null,M=null;async function Le(){return N||(await ce(),M=new Je,M.set_url("wss://pigeonmingle.com/ws/"),N={sendPosition:(i,o,s)=>{if(!M)return;const a=JSON.stringify({x:i,y:o,x_velocity:s.x,y_velocity:s.y});M.set_info(a)},getPlayerPosition:()=>(M==null?void 0:M.info)||"{}",receivePositions:()=>{try{if(!M)return console.warn("Client not initialized"),[];const i=M.getAllInfo();if(!i||i.size===0)return[];const o=[];return i.forEach((s,a)=>{try{const l=JSON.parse(s);o.push({peer_id:a,x:parseFloat(l.x)||0,y:parseFloat(l.y)||0,x_velocity:parseFloat(l.x_velocity)||0,y_velocity:parseFloat(l.y_velocity)||0})}catch(l){console.warn(`Failed to parse position data for peer ${a}:`,l)}}),o}catch(i){return console.error("Error processing positions data:",i),[]}},startServer:async()=>{if(!M)throw new Error("Client not initialized");try{console.log("Starting WebRTC client..."),await M.start(),console.log("WebRTC client started successfully")}catch(i){throw console.error("Failed to start client:",i),i}}},N)}class Ve{constructor(e){f(this,"stateMachine");f(this,"default");f(this,"textureAtlas",null);f(this,"atlasTexture",null);f(this,"uvMap",null);f(this,"frameWidth",null);f(this,"frameHeight",null);let n=null;e.values().forEach(r=>{if(r.default)if(!n)n=r;else throw new Error("Multiple default states in animation states map in animation manager instancing")}),n?this.default=n:this.default=Array.from(e.values())[0],this.stateMachine=e}assignAnimationState(e){for(const n of this.stateMachine.values())if(n.condition(e))return e.setAnimationState(n),!0;return e.setAnimationState(this.default),!1}async loadTextureAtlas(e){if(!this.textureAtlas)throw new Error("texture atlas loaded before creation");const n=this.textureAtlas,r=await createImageBitmap(n),i=e.createTexture({size:{width:n.width,height:n.height,depthOrArrayLayers:1},format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});return e.queue.copyExternalImageToTexture({source:r},{texture:i},[n.width,n.height,1]),this.atlasTexture=i,i}async createTextureAtlasFromStates(e){const n=Array.from(e.keys());let r=0,i=new Map;for(const d of n){const h=e.get(d);if(!h)throw new Error(`AnimationState not found for key: ${d}`);const E=[];for(let S=0;S<h.imagePath.length;S++)E.push(r+S);i.set(d,E),r+=h.imagePath.length}const o=[];for(const d of n){const h=e.get(d);if(h)for(const E of h.imagePath){const S=new Image;S.src=E,await S.decode(),o.push(S)}}const s=Math.max(...o.map(d=>d.width)),a=Math.max(...o.map(d=>d.height)),l=r*s,u=a,g=document.createElement("canvas");g.width=l,g.height=u;const A=g.getContext("2d");if(!A)throw new Error("Failed to get canvas context");const _=new Map;for(let d=0;d<o.length;d++)A.drawImage(o[d],d*s,0,s,a);for(const d of n){const h=i.get(d);if(!h)continue;const E=h.map(S=>S/r);_.set(d,E)}return this.textureAtlas=g,this.uvMap=_,this.frameWidth=s,this.frameHeight=a,{canvas:g,uvMap:_,frameWidth:s,frameHeight:a}}}class ze{constructor(){f(this,"scenes");f(this,"currScene",null);f(this,"inputManager");f(this,"audioManager");this.scenes=new Map,this.inputManager=new Ce,this.audioManager=new ke}addScene(e){this.scenes.set(e.id,e)}run(e){const n=this.scenes.get(e);if(n)this.currScene=e,Ge(n,this.audioManager);else throw new Error("invalid scene id")}getInputManager(){return this.inputManager}getAudioManager(){return this.audioManager}}function Ge(t,e){Ee(t.config.width,t.config.height).then(async n=>{if(n==null)throw new Error("WebGPU failed to initialize, FLOCK only runs in chrome");const r=await Le(),i=new Map;for(const[g,A]of Object.entries(t.config.animationStates)){const _=new Ve(A);await _.createTextureAtlasFromStates(A),await _.loadTextureAtlas(n.device),i.set(g,_)}const o=n.width,s=n.height,a=10,l=[{left:0,right:o,top:-a,bottom:0},{left:o,right:o+a,top:0,bottom:s},{left:0,right:o,top:s,bottom:s+a},{left:-a,right:0,top:0,bottom:s}],u=new me(n,new y,r,l,i);t.config.sounds&&await We(t.config.sounds,e),await fe(0,t.config.textures,u),t.preload(u),t.create(u),le(u,t.update)})}async function We(t,e){const n=Object.keys(t);for(let r=0;r<n.length;r++){const i=n[r],o=t[n[r]];await e.preloadAudio(i,o)}}function le(t,e){requestAnimationFrame(n=>{t.deltaTMS=n-t.lastT,t.lastT=n,e(t),le(t,e)})}async function fe(t,e,n){const r=Object.keys(e);if(t>=r.length)return;const i=await ve(n.renderConf,e[r[t]]);return i&&n.textures.set(r[t],i),fe(t+1,e,n)}const ue="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAACgCAYAAACLz2ctAAAAAXNSR0IArs4c6QAAAfRJREFUeJzt3DFKHGEYgOFd8TIRbCPYRCxTmhzCE6S1E6y38w5raRmSRjCtoIfwEOYCIUzx4zvOPE89DP8uL3+xH99uNgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwIeyrQ/w3n7/enob+b4vZ8er+w5HOqgPwLoJkJQASQmQlABJCZCUAEkJkJQASS3mV/zRE47RTEz+zQ1ISoCkBEhKgKQESEqApARISoCkBEhKgKQESEqApARISoCkBEhKgKQESEqApARIajF7CnPfCZlqbbsjbkBSAiQlQFICJCVAUgIkJUBSAiQlQFKr+tV9s1nfxOTT54uhn/flz93QZtyApARISoCkBEhKgKQESEqApARISoCkVjcJmWruE5PLH1dD3/f8uJ/03HY7OZlJD7oBSQmQlABJCZCUAEkJkJQASQmQlABJHdYHeG9zn3BUjk6+TX3UTgjLIUBSAiQlQFICJCVAUgIkJUBSAiSV7YScn36d9UTi6vqmPsJ/Td0JGf1vVqO5AUkJkJQASQmQlABJCZCUAEkJkJQASQ3fCZn7hGO01/3t0Pd93+1mPbkYzQ1ISoCkBEhKgKQESEqApARISoCkBEhqMTshPx/uVzVBWAo3ICkBkhIgKQGSEiApAZISICkBkhIgAAAAACzfX7SeMECFLuiBAAAAAElFTkSuQmCC",qe="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAACgCAYAAACLz2ctAAAAAXNSR0IArs4c6QAAAbBJREFUeJzt3DFKA0EYgNFEvIyCrYKNYmmpXiNnsBOscw21tBRtBG0FPY7WgoFFV7+YvFcvy4T5mGJ/JpMJAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPx/03oBfLa1e/I+5vvenm+Weo836gWw3gRISoCkBEhKgKQESEqApARISoCkNusF8D2vT9eDnptOp0MnK8nExAlISoCkBEhKgKQESEqApARISoCkBEjKJOSPPNy/jHrXY3vvdOij7oTAIgIkJUBSAiQlQFICJCVAUgIkJUBSJiELjD254GtOQFICJCVAUgIkJUBSAiQlQFICJCVAUkt9X+A3HO0fjzrhOL+4HPN1gx0c7qzE3jkBSQmQlABJCZCUAEkJkJQASQmQlABJLf2dkLEnF8tuVSYcQzkBSQmQlABJCZCUAEkJkJQASQmQlABJZV/dx55w3D3eJr9l6L9orduEYygnICkBkhIgKQGSEiApAZISICkBkhIgKV/nf+hqNht1onM2n6/VnjgBSQmQlABJCZCUAEkJkJQASQmQlABJfQC1iSHBMWrFbAAAAABJRU5ErkJggg==",Ze="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAACgCAYAAACLz2ctAAAAAXNSR0IArs4c6QAAAcNJREFUeJzt2zFKHVEUgOF5IZsxkNaAjWJpGbMN12AnWNu5BrW0DNoEklaIi8gikjqFcMEr/3Pe99XDcN+bn9Mc7rIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwPu3qQ+wK/b2v/6d+b7nX3er+HYf6gOw2wRISoCkBEhKgKQESEqApARISoCkPtYH4H+/f94OPbfZbEY3K1u9MTEBSQmQlABJCZCUAEkJkJQASQmQlABJ2YS80uPD09S7Hp++nI4+utUbjlEmICkBkhIgKQGSEiApAZISICkBkhIgqZ3bhMzeXPA6JiApAZISICkBkhIgKQGSEiApAZISIKlV3CtYlmU5PjiZuuE4v7ic+bphh0efV/NNRpiApARISoCkBEhKgKQESEqApARISoCksjshszcX227XNhyjTEBSAiQlQFICJCVAUgIkJUBSAiQlQFLTNyGzNxzff9wnG4Tz5XLod/y5vX7ro6yaCUhKgKQESEqApARISoCkBEhKgKQESMo9hRfcnJ0NbUK+XV0N/Yez37cWJiApAZISICkBkhIgKQGSEiApAZISIKl/p9El/cH4tLQAAAAASUVORK5CYII=",Xe="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAACgCAYAAACLz2ctAAAAAXNSR0IArs4c6QAAAZ5JREFUeJzt3TEuBVEYgFFPbIZES6IhSiUWodFqRavViDVgDZS0EhZhEdQSkpuY+Abn1DeTm5kvt5g/897SEgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwX4t6A3y0urH/NuX1Xh5vZ/2Ml+sN8L8JkJQASQmQlABJCZCUAEkJkJQASc36LflvcH/3NOnk4ujkdGjd88PN0LrFYvgRJy04AUkJkJQASQmQlABJCZCUAEkJkJQASa3UG/hpU08uKmubB6NLZz3tcgKSEiApAZISICkBkhIgKQGSEiApAZLKJiG7W3t/YiIxtcvzs6F12zvrs55wjHICkhIgKQGSEiApAZISICkBkhIgKQGSGp6EmFx8z1+ZXEzNCUhKgKQESEqApARISoCkBEhKgKQESMrb+S+M/orW683V0PUOLy7c6084AUkJkJQASQmQlABJCZCUAEkJkJQASf27/wkZNfoNx/XxsW9lvsEJSEqApARISoCkBEhKgKQESEqApARI6h2EsyBTNdp3/gAAAABJRU5ErkJggg==",je="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAACgCAYAAACLz2ctAAAAAXNSR0IArs4c6QAAAYdJREFUeJzt3DFKA0EAhtFEvIyFrYWNYmnpKTyBbTrBw2hpKdoI2gp6HD1BYIWRb1jfq8OwgY8p8rPZbAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAeW3rB+BvHZ1cfY887+v9YWgzByMPg98SICkBkhIgKQGSEiApAZISICkBkrKE7PHy/DF0QRjt+mY39LzPt/tFn9tuFyez6INuQFICJCVAUgIkJUBSAiQlQFICJCVAUv9uCZl94Rht9GLinRBWRYCkBEhKgKQESEqApARISoCkBEgqW0IuTi+nXiR2t3f1Iwxxdn489drlBiQlQFICJCVAUgIkJUBSAiQlQFICJHU4+sDZFw7m4gYkJUBSAiQlQFICJCVAUgIkJUBSAiS1mndCnl4fh36X2f9Fa/Z3PZZyA5ISICkBkhIgKQGSEiApAZISICkBklrFr+mlajGxhMAAAiQlQFICJCVAUgIkJUBSAiQlQFI/kzkkTiD1xVgAAAAASUVORK5CYII=",He="/mingle/assets/grass-BrdUSFv8.jpg",$e="/mingle/assets/sky-Brfth9xq.png";function et(t,e,n){t.wasm.sendPosition(e.x,e.y,n)}const V=new Map,tt=5e3,de=250,Y=new Map,nt={condition:t=>Math.abs(t.velocity.x)<3&&t.grounded,imagePath:[qe],transitionTo:["wing","walk","flap"],default:!0,frameDuration:100},rt={condition:t=>!t.grounded,imagePath:[ue],transitionTo:["idle","walk","flap"],default:!1,frameDuration:100},it=[Ze,Xe],ot={condition:t=>Math.abs(t.velocity.x)>5&&t.grounded,imagePath:it,transitionTo:["idle","wing","flap"],default:!1,frameDuration:100},st=[je,ue],at={condition:t=>!t.grounded&&(t.velocity.y<0||t.metadata.prevVelY>=t.velocity.y),imagePath:st,transitionTo:["idle","wing","walk"],default:!1,frameDuration:de};Y.set("idle",nt);Y.set("flap",at);Y.set("wing",rt);Y.set("walk",ot);function ct(t){(t.wasm.receivePositions()||[]).forEach((n,r)=>{const i=`remoteSprite${r}`;if(V.set(i,0),t.hasRemoteSprite(i)){const o=t.getRemoteSprite(i);o.metadata.prevVelY=o.velocity.y;const s=new y(n.x_velocity,n.y_velocity),a=new y(n.x,n.y);a.sub(o.position),s.add(a),o.velocity.setFromV2(s)}else{const o=new se(t,"pigeon",i,Q.REMOTE);o.scale.set(50,50),o.position.set(n.x,n.y),o.velocity.set(n.x_velocity,n.y_velocity),o.metadata.prevVelY=0}})}const lt={textures:{debug:He,background:$e},animationStates:{pigeon:Y},height:0,width:0,sceneId:"main"},ft=t=>{const e=new q(t,"background","background",Q.TERRAIN);e.position.set(0,0),e.scale.set(1e4,1e4),e.static=!0,e.collisions=!1;const n=new q(t,"debug","debug",Q.TERRAIN);n.position.set(0,750),n.scale.set(1e4,500),n.static=!0;const r=new se(t,"pigeon","bird1",Q.LOCAL);r.metadata.prevVelY=0,r.metadata.flapTimer=de,r.position.set(50,700),r.scale.set(50,50),t.wasm.startServer().then(()=>{console.log("P2P server started.")}),t.boundCamera.setZoom(1.5)},te=200,ne=t=>{t.velocity.x>0?t.flipX=!1:t.velocity.x<0&&(t.flipX=!0)},ut=t=>{const e=t.getLocalSprite("bird1");e.metadata.flapTimer-=t.deltaTMS,e.metadata.flapTimer<=0&&(e.metadata.prevVelY=e.velocity.y),J.getInputManager().isKeyDown(P.D_KEY)?e.grounded?e.velocity.setX(75):e.velocity.lerp(new y(te,e.velocity.y),t.deltaTMS*.001):J.getInputManager().isKeyDown(P.A_KEY)?e.grounded?e.velocity.setX(-75):e.velocity.lerp(new y(-te,e.velocity.y),t.deltaTMS*.001):e.grounded?e.velocity.setX(0):e.velocity.lerp(new y(0,e.velocity.y),t.deltaTMS*.001),J.getInputManager().onKeyDown(P.SPACE)&&e.velocity.add(new y(0,-50)),e.velocity.add(new y(0,1)),ct(t);const n=t.deltaTMS;for(const[i,o]of V.entries())n+o>tt?(t.remoteSprites.get(i)&&t.remoteSprites.delete(i),V.delete(i)):V.set(i,o+n);t.localSpritesIterable().forEach(i=>{ne(i),i.lerpByVelocity(t)}),t.remoteSpriteIterable().forEach(i=>{i.lerpByVelocity(t),ne(i),Math.abs(i.velocity.y)<2&&(i.grounded=!0)});for(const i of t.localSprites.values())i.resetGrounded();for(const i of t.remoteSprites.values())i.resetGrounded();e.blockOnWalls(t),e.blockOnTerrain(t),t.boundCamera.setPosition(e.position.x,e.position.y-100),xe(t),et(t,e.position,e.velocity)},dt={id:"demo",preload:()=>{},create:ft,update:ut,config:lt},J=new ze;J.addScene(dt);J.run("demo");
